rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // =========================================================
    // Helper Functions
    // =========================================================
    
    function isSignedIn() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    // Check if the user is the 'uploaderId' of the generic document
    function isResourceOwner() {
      return isSignedIn() && (
        (resource == null && request.resource.data.uploaderId == request.auth.uid) ||
        (resource != null && resource.data.uploaderId == request.auth.uid)
      );
    }

    // =========================================================
    // Collection Rules
    // =========================================================

    // 1. User Data & User History
    // Strictly restrict access to the user themselves
    match /users/{userId} {
      allow read, write: if isSignedIn() && isOwner(userId);
      
      // Allow access to subcollections (like history, settings)
      match /{document=**} {
        allow read, write: if isSignedIn() && isOwner(userId);
      }
    }
    
    // 2. Generic Documents (Root Level)
    match /documents/{document=**} {
      allow read, write: if isResourceOwner();
    }

    // 3. Activity Logs (Audit Trail)
    match /activity_logs/{logId} {
      allow create: if isSignedIn();
      allow read, delete: if isSignedIn() && resource.data.userId == request.auth.uid;
    }
    
    // 4. Contact Messages (Public Form)
    match /contact_messages/{messageId} {
      allow create: if true;
      allow read, update, delete: if false; 
    }

    // 5. Stripe Customers & Billing
    match /customers/{uid} {
      allow read: if request.auth.uid == uid;

      match /checkout_sessions/{id} {
        allow read, write: if request.auth.uid == uid;
      }
      match /subscriptions/{id} {
        allow read: if request.auth.uid == uid;
      }
      match /payments/{id} {
        allow read: if request.auth.uid == uid;
      }
    }

    // 6. Stripe Products & Prices (Public Read)
    match /products/{id} {
      allow read: if true;
      match /prices/{id} {
        allow read: if true;
      }
      match /tax_rates/{id} {
        allow read: if true;
      }
    }

    // 7. Public Checklists (Sharing System)
    match /publicChecklists/{shareId} {
      
      function isChecklistOwner() {
        return request.auth != null && resource.data.ownerUid == request.auth.uid;
      }

      function isPublic() {
        return resource.data.permissions.public.enabled == true;
      }

      function isInvited() {
        return request.auth != null && 
               resource.data.permissions.users != null &&
               request.auth.token.email in resource.data.permissions.users;
      }

      function getPublicRole() {
        return resource.data.permissions.public.role;
      }

      function getUserRole() {
        return resource.data.permissions.users[request.auth.token.email].role;
      }

      function hasRole(role) {
        return (isPublic() && getPublicRole() == role) ||
               (isInvited() && getUserRole() == role);
      }

      function isEditor() {
        return hasRole('editor');
      }

      // Read Access
      allow read: if resource == null || isChecklistOwner() || isPublic() || isInvited();

      // Create Access
      allow create: if request.auth != null && request.resource.data.ownerUid == request.auth.uid;

      // Update Access
      allow update: if 
        isChecklistOwner() || 
        (
          // View Count (Anyone with read access)
          request.resource.data.diff(resource.data).affectedKeys().hasOnly(['viewCount']) && 
          (isPublic() || isInvited())
        ) ||
        (
          // Editor
          isEditor() && 
          request.resource.data.diff(resource.data).affectedKeys().hasOnly(['title', 'analysisResult', 'updatedAt', 'viewCount'])
        );

      // Delete Access
      allow delete: if isChecklistOwner();
    }
    
    // 8. Public Team Settings (Collect Cash Page)
    match /settings/team_payment_status {
      allow read, write: if true;
    }
  }
}
